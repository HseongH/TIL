# 2. EC2

## Amazon Elastic Compute Cloud

애플리케이션 구동 시 서버가 필요하며 서버 구동 시에는 컴퓨터가 필요합니다. aws에서는 Amazon Elastic Compute Cloud(EC2)를 통해 해당 서비스를 제공합니다.

1. 기존 온프라미스 리소스 사용

   - 리소스 구성에 필요한 하드웨어를 구매해야 합니다.
   - 서버가 배달될 때까지 기다려야 합니다.
   - 데이터 센터에 서버를 설치해야 합니다.
   - 필요한 보안을 설정해야 합니다.
   - 서버 구매 시 사용여부와 관계없이 무조건 소유해야 합니다.

2. EC2 인스턴스 사용

   - 몇 분이면 EC2 인스턴스를 프로비저닝하고 사용할 수 있습니다.
   - 인스턴스를 늘리거나 필요없는 인스턴스의 사용 중단이 가능합니다.
   - 인스턴스가 실행 중일 때 사용한 만큼만 비용을 지불합니다. 중단된 인스턴스에 대한 비용은 지불하지 않습니다.
   - 더 많은 메모리와 CPU를 제공하는 등 인스턴스의 수직 확장이 용이합니다.

---

## EC2 인스턴스 유형

EC2에는 사용 목적에 따라 다양한 인스턴스 유형이 존재합니다. 범용 인스턴스, 메모리 최적화 인스턴스, 컴퓨팅 최적화 인스턴스, 엑셀러레이티드 컴퓨팅 인스턴스, 스토리지 최적화 인스턴스 등이 이에 해당합니다.

1. 범용 인스턴스

   - 컴퓨팅, 메모리, 네트워크 리소스를 균형있게 제공하는 인스턴스입니다.
   - 애플리케이션 서버, 게임 서버, 중소 규모 데이터 베이스 등의 워크로드에 적합합니다.

2. 컴퓨팅 최적화 인스턴스

   - 고성능 프로세서를 활용하는 컴퓨팅 집약적인 서버에 적합합니다.
   - 범용 인스턴스와 같이 웹 서버, 애플리케이션 서버 등의 워크로드에 사용할 수 있지만 고성능 웹 서버, 게임 전용 서버에 적합하다는 특징이 있습니다.

3. 메모리 최적화 인스턴스

   - 메모리에서 대규모 데이터 세트를 처리하는 워크로드에 빠른 성능을 제공하기 위해 설계되었습니다.
   - 애플리케이션 실행 전 많은 데이터를 로드해야 하는 워크로드 고성능 데이터베이스, 방대한 양의 비정형 데이터의 실시간 처리가 필요한 워크로드에 적합합니다.

4. 엑셀러레이티드 컴퓨팅 인스턴스

   - 부동 소수점 계산, 그래픽 처리, 데이터 패턴 일치 등 일부 기능은 CPU에서 실행하는 것보다 엑셀러레이터 또는 코프로세서를 이용하는 것이 더 효율적입니다.
   - 그래픽 애플리케이션, 게임 스트리밍, 애플리케이션 스트리밍 같은 워크로드에 적합합니다.

5. 스토리지 최적화 인스턴스
   - 로컬 스토리지의 대규모 데이터 세트에 관한 순차적 읽기, 쓰기가 빈번하게 일어나는 워크로드를 위해 설계되었습니다.
   - 분산 파일 시스템, 데이터 웨어하우징 애플리케이션, 고빈도 온라인 트랜잭션 처리(OLTP) 시스템 등의 워크로드에 적합합니다.

---

## Amazon EC2 요금

EC2에는 다양한 요금제가 제공됩니다.

1. 온디맨드

   - 장기 약정이나 선결재 없이 사용한 만큼 비용이 발생하는 요금제입니다.
   - 인스턴스를 처음 사용하여 워크로드를 테스트하며 인스턴스 사용량을 조정하고 싶을 때 사용합니다.
   - 평균 사용량 기준을 확인한 후 Savings Plans로 전환할 수 있습니다.
   - 애플리케이션 개발 및 테스트, 예측할 수 없는 사용 패턴이 있는 애플리케이션에 적합합니다.
   - 1년 이상 사용되는 워크로드에는 적합하지 않으며 이때는 예약 인스턴스를 사용하면 비용 절감에 도움됩니다.

2. Amazon EC2 Savings Plans

   - 일정 사용량을 약정하여 EC2를 좀 더 저렴하게 사용할 수 있습니다.
   - 1년 또는 3년 약정을 통해 사용하며 일정 사용량까지는 할인된 인스턴스 비용이 청구되고 일정 사용량을 초과한 경우에는 온디맨드 요금이 부과됩니다.
   - 온디맨드 요금에 비해 최대 72%까지 비용을 절감할 수 있습니다.

3. 예약 인스턴스

   - 꾸준한 상태의 워크로드나 사용량이 예측가능한 워크로드에 적합합니다.
   - 온디맨드 인스턴스를 사용할 때 적용되는 결재 할인 옵션입니다.
   - 1년 또는 3년 약정을 통해 사용하며 정기 예약 인스턴스는 1년 약정으로 사용합니다.
   - 인스턴스 약정 기간이 끝나도 중단 없이 EC2 인스턴스를 사용할 수 있습니다.
   - 인스턴스를 종료한 경우, 인스턴스 속성과 일치하는 새 예약 인스턴스를 구입한 경우 온디맨드 요금이 부과됩니다.
   - 온디맨드 요금에 비해 최대 75%까지 비용을 절감할 수 있습니다.

4. 스팟 인스턴스

   - 시작 및 종료 시점이 자유롭거나 중단에 견딜 수 있는 워크로드에 적합합니다.
   - 미사용 EC2 컴퓨팅 용량을 사용하며 온디맨드 요금의 최대 90%까지 비용을 절감할 수 있습니다.
   - 스팟 요청을 하고 미사용 EC2 용량이 없는 경우 EC2 용량을 사용할 수 있을 때까지 요청이 수행되지 않습니다. 인스턴스 시작 후 용량을 더 이상 사용할 수 없거나 인스턴스 수요가 늘어날 경우 인스턴스가 중단될 수 있습니다.

5. 전용 호스트
   - EC2 전용으로 제공되는 물리적 호스트입니다.
   - 모든 인스턴스 옵션 중 비용이 가장 많이 발생하는 인스턴스 입니다.

---

## EC2 확장

EC2의 장점 중 하나는 확장성과 탄력성입니다. 기업의 필요에 맞게 용량을 늘리거나 줄이는 방법입니다.

온프레미스 환경은 딜레마가 있습니다. 고객의 워크로드가 많은 시즌이 있거나 수요가 발생하지 않는 주가 있을 수 있습니다. 데이터 센터 구축 시 평균 사용량만큼 하드웨어를 구매한다면 평균적으로는 돈을 낭비하지 않게 됩니다. 하지만 피크 부하가 발생하는 경우 하드웨어가 부족해 서비스를 제공받지 못하는 고객이 발생합니다.

최대 부하에 맞춰 하드웨어를 구매한다면 고객의 요청에는 대응할 수 있겠지만 대부분의 시간에 유휴 리소스가 발생합니다. 온프레미스 환경에서는 이같은 딜레마를 해결할 방법이 없습니다.

AWS에서는 매일 매시간의 수요에 맞는 워크로드를 프로비저닝할 수 있습니다.

첫 번째로 장애에 대응하는 방법입니다. 현재 사용 중인 인스턴스에 장애가 발생한다면 AWS는 현재 인스턴스와 동일한 방식으로 프로그래밍된 두 번째 인스턴스를 생성합니다. 하나의 인스턴스에 장애가 발생해도 동일하게 생성된 다른 인스턴스를 이용해 고객의 요청을 처리할 수 있습니다.

두 번째는 수요의 변화에 대한 대응 방법입니다. 두 가지 방법으로 수요 변화를 처리할 수 있는데 수직 확장과 수평 확장입니다.

수직 확장은 실행 중인 장치에 성능을 추가하는 방식으로 일부 사례에서는 도움이 되지만 고려할 점이 있습니다. 한 고객의 요청이 지속적으로 발생하면 인스턴스의 성능이 좋다고 해서 증가하는 고객의 요청을 빠르게 처리하지는 못합니다.

이때 수평 확장을 통해 사용 가능한 인스턴스 개수를 늘려 요청을 처리할 수 있습니다. 현재 사용 중인 인스턴스와 똑같은 방식으로 프로그래밍된 인스턴스를 생성해 고객의 요청을 분산시킵니다.

증가하는 수요를 모두 처리한 후 서버에 요청이 줄어들게 되면 AWS는 필요 없어진 인스턴스를 중단시켜 유휴 리소스를 제거합니다.

### Amazon EC2 Auto Scaling

서버의 수요에 맞춰 인스턴스를 자동으로 조정하는 AWS 서비스입니다. 수요에 따라 인스턴스를 자동으로 추가하거나 제거할 수 있습니다.

동적 조정과 예측 조정이라는 두 가지 접근 방식을 사용할 수 있습니다.

- 동적 조정은 수요 변화에 대응합니다.
- 예측 조정은 예측된 수요에 따라 적절한 수의 인스턴스를 자동으로 예약합니다.

Auto Scaling 그룹의 크기를 구성할 때 최소 EC2 인스턴스 수를 설정할 수 있습니다. 희망 인스턴스 용량을 설정할 수 있으며 최대 용량을 제한할 수도 있습니다.

---

## Elastic Load Balancing을 사용하여 트래픽 리디렉션

Auto Scaling을 통해 인스턴스를 유연하게 확장 가능하게 되었지만 여전히 인스턴스의 부하는 발생합니다. 고객은 어느 인스턴스에 요청을 보내야할지 모르기 때문에 하나의 인스턴스에만 부하가 몰립니다. 이때 로드 밸런서를 이용해 각 인스턴스의 트래픽을 분석해 현재 트래픽이 가장 적은 인스턴스에 요청을 보내는 작업이 필요합니다. AWS에서는 Elastic Load Balancing을 사용해 로드 밸런싱 작업을 수행할 수 있습니다.

ELB는 외부 요청뿐만 아니라 내부 요청도 처리 가능합니다. 프런트엔드 인스턴스와 백엔드 인스턴스가 서로 통신하는 방식을 살펴보면 프런트엔드 인스턴스는 백엔드 인스턴스에 요청을 보냅니다. 부하가 증가하면 백엔드 인스턴스가 새로 생성되고 Auto Scaling이 각 프런트엔드 인스턴스에 리소스 수신이 가능하다고 알립니다. 이는 인스턴스가 적어도 매우 복잡한 구조를 가집니다.

ELB는 프런트엔드의 요청을 수신해 백엔드 인스턴스의 트래픽을 분석한 후 요청을 전송합니다. 부하가 증가하면 Auto Scaling에 인스턴스 증가 요청을 보내고 새 인스턴스가 생성되면 Auto Scaling은 리소스 수신이 가능하다는 상태를 전송한 후 꺼집니다. 이후 ELB가 각 인스턴스의 부하에 맞춰 밸런싱 작업을 수행합니다. 프런트엔드는 백엔드 인스턴스가 몇개 존재하는지 알 필요가 없습니다.

### Amazon Elastic Load Balancing

ELB는 로드 밸런싱 작업을 수행하는 AWS 서비스입니다. 고객의 요청을 수신해 각 인스턴스의 부하를 분석하고 트래픽에 맞춰 요청을 송신합니다. 부하가 증가하면 Auto Scaling에게 인스턴스 증가 요청을 보내고 그에 맞춰 새 인스턴스가 생성됩니다. 부하가 줄어들면 신규 인스턴스에 대한 요청은 중단하고 Auto Scaling에게 인스턴스 중단을 요청합니다. Auto Scaling은 인스턴스가 현재 진행 중인 요청이 완료되면 ELB의 요청에 맞춰 인스턴스를 중단시킵니다.

ELB와 Auto Scaling은 별도의 서비스이지만 서로 연동하여 EC2에서 실행되는 애플리케이션의 뛰어난 성능과 가용성을 제공합니다.
